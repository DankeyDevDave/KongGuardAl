# Kong Production Configuration
# Optimized for security, performance, and observability

# Basic Settings
prefix = /var/lib/kong/
log_level = info

# Database Settings (will be overridden by environment variables)
database = postgres
pg_host = kong-db
pg_port = 5432
pg_user = kong
pg_database = kong
pg_ssl = off
pg_ssl_verify = off

# Network Settings
proxy_listen = 0.0.0.0:8000, 0.0.0.0:8443 ssl
admin_listen = 0.0.0.0:8001

# SSL Configuration
ssl_cert = /etc/kong/certs/kong.crt
ssl_cert_key = /etc/kong/certs/kong.key
admin_ssl_cert = /etc/kong/certs/admin.crt
admin_ssl_cert_key = /etc/kong/certs/admin.key

# Logging
access_log = /var/log/kong/access.log
error_log = /var/log/kong/error.log
admin_access_log = /var/log/kong/admin_access.log
admin_error_log = /var/log/kong/admin_error.log

# Plugin Configuration
plugins = bundled,kong-guard-ai
lua_package_path = /usr/local/share/lua/5.1/?.lua;;

# Performance Tuning
nginx_worker_processes = auto
nginx_worker_connections = 4096
upstream_keepalive_pool_size = 512
upstream_keepalive_max_requests = 1000
upstream_keepalive_idle_timeout = 60s

# Memory Management
mem_cache_size = 128m
lua_shared_dict_cache_size = 64m
lua_shared_dict_rate_limit = 32m
lua_shared_dict_threat_cache = 64m

# Security Headers
headers = off
server_tokens = off

# Rate Limiting
nginx_http_client_body_buffer_size = 128k
nginx_http_client_max_body_size = 100m
nginx_http_large_client_header_buffers = 16 128k

# DNS Resolution
dns_resolver = 127.0.0.11:53
dns_hostsfile = /etc/hosts
dns_order = LAST,SRV,A,CNAME

# Clustering (for multi-node deployments)
cluster_listen = 0.0.0.0:8005
cluster_cert = /etc/kong/certs/cluster.crt
cluster_cert_key = /etc/kong/certs/cluster.key

# Status Page
status_listen = 0.0.0.0:8100

# Real IP Configuration
real_ip_header = X-Real-IP
real_ip_recursive = on
trusted_ips = 198.51.100.0/8,233.252.0.0/12,203.0.113.0/16

# Event Hooks
event_hooks_enabled = on

# Kong Guard AI Specific Shared Dictionaries
lua_shared_dict kong_guard_ai_cache = 64m
lua_shared_dict kong_guard_ai_rate_limit = 32m
lua_shared_dict kong_guard_ai_ip_blacklist = 16m
lua_shared_dict kong_guard_ai_counters = 16m
lua_shared_dict kong_guard_ai_ai_cache = 32m