<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kong Guard AI - Live Threat Detection Visualization</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        
        @keyframes threatFlow {
            0% { transform: translateX(-100%); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        
        @keyframes aiThinking {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pulse { animation: pulse 2s infinite; }
        .threat-flow { animation: threatFlow 3s infinite; }
        .ai-thinking { animation: aiThinking 2s linear infinite; }
        
        .threat-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ff4444;
            border-radius: 50%;
            animation: threatFlow 2s linear infinite;
        }
        
        .safe-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #44ff44;
            border-radius: 50%;
            animation: threatFlow 2s linear infinite;
        }
        
        .gradient-border {
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .threat-high { background: linear-gradient(135deg, #ff4444, #cc0000); }
        .threat-medium { background: linear-gradient(135deg, #ffaa00, #ff6600); }
        .threat-low { background: linear-gradient(135deg, #44ff44, #00cc00); }
        .threat-none { background: linear-gradient(135deg, #4444ff, #0066cc); }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // WebSocket connection
        let ws = null;

        function App() {
            const [connected, setConnected] = useState(false);
            const [metrics, setMetrics] = useState({
                total_requests: 0,
                threats_blocked: 0,
                threats_allowed: 0,
                avg_latency: 0,
                current_rps: 0,
                ai_accuracy: 95.5
            });
            const [events, setEvents] = useState([]);
            const [aiThinking, setAiThinking] = useState(null);
            const [threatMap, setThreatMap] = useState({});
            const chartRef = useRef(null);
            const latencyChartRef = useRef(null);

            useEffect(() => {
                // Connect to WebSocket
                ws = new WebSocket('ws://localhost:8000/ws');
                
                ws.onopen = () => {
                    setConnected(true);
                    console.log('Connected to Kong Guard AI');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.type === 'connection') {
                        setMetrics(data.metrics);
                        if (data.history) {
                            setEvents(data.history.slice(-10));
                        }
                    } else if (data.type === 'threat_analysis') {
                        setMetrics(data.metrics);
                        setEvents(prev => [data.event, ...prev].slice(0, 20));
                        updateThreatMap(data.event);
                    } else if (data.type === 'ai_thinking') {
                        setAiThinking(data.data);
                        setTimeout(() => setAiThinking(null), 2000);
                    }
                };
                
                ws.onclose = () => {
                    setConnected(false);
                };
                
                return () => {
                    if (ws) ws.close();
                };
            }, []);

            const updateThreatMap = (event) => {
                setThreatMap(prev => {
                    const type = event.threat_type;
                    return {
                        ...prev,
                        [type]: (prev[type] || 0) + 1
                    };
                });
            };

            const simulateAttack = async (type) => {
                const attacks = {
                    sql: {
                        method: "GET",
                        path: "/api/users",
                        query: "id=1' UNION SELECT * FROM passwords--"
                    },
                    xss: {
                        method: "POST",
                        path: "/api/comment",
                        body: '{"text":"<img src=x onerror=alert(document.cookie)>"}'
                    },
                    ddos: {
                        method: "GET",
                        path: "/api/data",
                        requests_per_minute: 500
                    },
                    normal: {
                        method: "GET",
                        path: "/api/products",
                        query: "category=electronics"
                    }
                };

                const attack = attacks[type];
                const response = await fetch('http://localhost:8000/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        features: {
                            method: attack.method,
                            path: attack.path,
                            client_ip: `192.168.1.${Math.floor(Math.random() * 255)}`,
                            user_agent: type === 'normal' ? "Chrome/96.0" : "AttackBot/1.0",
                            requests_per_minute: attack.requests_per_minute || 10,
                            content_length: attack.body ? attack.body.length : 0,
                            query_param_count: attack.query ? 1 : 0,
                            header_count: 5,
                            hour_of_day: new Date().getHours(),
                            query: attack.query || "",
                            body: attack.body || ""
                        },
                        context: {
                            previous_requests: Math.floor(Math.random() * 100),
                            failed_attempts: type === 'normal' ? 0 : Math.floor(Math.random() * 10)
                        }
                    })
                });
            };

            const runDemoSequence = async () => {
                const sequence = ['normal', 'sql', 'normal', 'xss', 'normal', 'ddos', 'sql', 'normal'];
                for (const attack of sequence) {
                    await simulateAttack(attack);
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            };

            return (
                <div className="min-h-screen p-6">
                    {/* Header */}
                    <div className="text-center mb-8">
                        <h1 className="text-5xl font-bold mb-2 bg-gradient-to-r from-blue-400 to-purple-600 bg-clip-text text-transparent">
                            Kong Guard AI
                        </h1>
                        <p className="text-xl text-gray-400">Real-Time AI-Powered Threat Detection</p>
                        <div className="mt-4">
                            <span className={`inline-block px-4 py-2 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`}>
                                {connected ? '🟢 Connected' : '🔴 Disconnected'}
                            </span>
                        </div>
                    </div>

                    {/* Metrics Dashboard */}
                    <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                        <MetricCard title="Total Requests" value={metrics.total_requests} color="blue" />
                        <MetricCard title="Threats Blocked" value={metrics.threats_blocked} color="red" />
                        <MetricCard title="Safe Requests" value={metrics.threats_allowed} color="green" />
                        <MetricCard title="Current RPS" value={metrics.current_rps} color="yellow" />
                        <MetricCard title="Avg Latency" value={`${metrics.avg_latency}ms`} color="purple" />
                        <MetricCard title="AI Accuracy" value={`${metrics.ai_accuracy}%`} color="indigo" />
                    </div>

                    {/* Attack Simulator */}
                    <div className="bg-gray-800 rounded-lg p-6 mb-8">
                        <h2 className="text-2xl font-bold mb-4">🎯 Attack Simulator</h2>
                        <div className="flex flex-wrap gap-4">
                            <AttackButton onClick={() => simulateAttack('sql')} type="SQL Injection" danger="high" />
                            <AttackButton onClick={() => simulateAttack('xss')} type="XSS Attack" danger="high" />
                            <AttackButton onClick={() => simulateAttack('ddos')} type="DDoS Burst" danger="medium" />
                            <AttackButton onClick={() => simulateAttack('normal')} type="Normal Traffic" danger="none" />
                            <button
                                onClick={runDemoSequence}
                                className="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold hover:scale-105 transition"
                            >
                                🎬 Run Demo Sequence
                            </button>
                        </div>
                    </div>

                    {/* Main Content Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* AI Analysis Panel */}
                        <div className="bg-gray-800 rounded-lg p-6">
                            <h2 className="text-2xl font-bold mb-4 flex items-center">
                                🧠 AI Analysis Engine
                                {aiThinking && <span className="ml-4 ai-thinking">⚙️</span>}
                            </h2>
                            
                            {aiThinking && (
                                <div className="bg-gray-700 rounded-lg p-4 mb-4 pulse">
                                    <div className="text-yellow-400 font-bold">{aiThinking.status}</div>
                                    <div className="text-sm text-gray-300">{aiThinking.message}</div>
                                    {aiThinking.details && (
                                        <div className="mt-2 text-xs text-gray-400">
                                            Checking: {aiThinking.details.indicators_checking?.join(', ')}
                                        </div>
                                    )}
                                </div>
                            )}

                            <ThreatDistribution threatMap={threatMap} />
                        </div>

                        {/* Live Events */}
                        <div className="bg-gray-800 rounded-lg p-6">
                            <h2 className="text-2xl font-bold mb-4">📊 Live Threat Feed</h2>
                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                {events.map((event, index) => (
                                    <EventCard key={index} event={event} index={index} />
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Threat Flow Visualization */}
                    <div className="mt-8 bg-gray-800 rounded-lg p-6">
                        <h2 className="text-2xl font-bold mb-4">🌐 Threat Flow Visualization</h2>
                        <ThreatFlowVisualization events={events} />
                    </div>
                </div>
            );
        }

        function MetricCard({ title, value, color }) {
            return (
                <div className={`bg-gray-800 rounded-lg p-4 border-2 border-${color}-500`}>
                    <div className="text-sm text-gray-400">{title}</div>
                    <div className={`text-2xl font-bold text-${color}-400`}>{value}</div>
                </div>
            );
        }

        function AttackButton({ onClick, type, danger }) {
            const colors = {
                high: 'bg-red-600 hover:bg-red-700',
                medium: 'bg-orange-600 hover:bg-orange-700',
                low: 'bg-yellow-600 hover:bg-yellow-700',
                none: 'bg-green-600 hover:bg-green-700'
            };

            return (
                <button
                    onClick={onClick}
                    className={`px-6 py-3 ${colors[danger]} rounded-lg font-bold hover:scale-105 transition`}
                >
                    {type}
                </button>
            );
        }

        function EventCard({ event, index }) {
            const threatLevel = event.threat_score > 0.8 ? 'high' : 
                              event.threat_score > 0.5 ? 'medium' : 
                              event.threat_score > 0.2 ? 'low' : 'none';
            
            const bgColors = {
                high: 'bg-red-900',
                medium: 'bg-orange-900',
                low: 'bg-yellow-900',
                none: 'bg-green-900'
            };

            return (
                <div className={`${bgColors[threatLevel]} rounded-lg p-3 ${index === 0 ? 'pulse' : ''}`}>
                    <div className="flex justify-between items-start">
                        <div>
                            <div className="font-bold">
                                {event.method} {event.path}
                            </div>
                            <div className="text-sm text-gray-300">
                                Type: {event.threat_type} | Score: {event.threat_score?.toFixed(2)} | Action: {event.action}
                            </div>
                        </div>
                        <div className="text-xs text-gray-400">
                            {event.client_ip}
                        </div>
                    </div>
                </div>
            );
        }

        function ThreatDistribution({ threatMap }) {
            const total = Object.values(threatMap).reduce((a, b) => a + b, 0);
            
            return (
                <div className="space-y-2">
                    <div className="text-sm text-gray-400 mb-2">Threat Distribution</div>
                    {Object.entries(threatMap).map(([type, count]) => (
                        <div key={type} className="flex items-center gap-2">
                            <div className="w-24 text-sm">{type}</div>
                            <div className="flex-1 bg-gray-700 rounded-full h-6 relative">
                                <div 
                                    className="absolute top-0 left-0 h-full bg-gradient-to-r from-red-500 to-orange-500 rounded-full"
                                    style={{ width: `${(count / Math.max(total, 1)) * 100}%` }}
                                />
                                <span className="absolute inset-0 flex items-center justify-center text-xs">
                                    {count}
                                </span>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        function ThreatFlowVisualization({ events }) {
            return (
                <div className="relative h-32 bg-gray-900 rounded-lg overflow-hidden">
                    <div className="absolute inset-0 flex items-center justify-between px-8">
                        <div className="text-center">
                            <div className="text-2xl mb-2">👤</div>
                            <div className="text-xs">Client</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl mb-2">🔍</div>
                            <div className="text-xs">Kong Gateway</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl mb-2">🧠</div>
                            <div className="text-xs">AI Engine</div>
                        </div>
                        <div className="text-center">
                            <div className="text-2xl mb-2">🛡️</div>
                            <div className="text-xs">Decision</div>
                        </div>
                    </div>
                    
                    {/* Animated particles */}
                    {events.slice(0, 5).map((event, i) => (
                        <div
                            key={i}
                            className={event.threat_score > 0.5 ? 'threat-particle' : 'safe-particle'}
                            style={{
                                top: `${20 + i * 15}px`,
                                animationDelay: `${i * 0.5}s`
                            }}
                        />
                    ))}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>