# Kong Gateway Development Configuration for Kong Guard AI
# Enhanced logging and debugging settings for development

# Basic settings
prefix = /usr/local/kong
log_level = debug
plugins = bundled,kong-guard-ai

# Database settings (PostgreSQL for development)
database = postgres
pg_host = kong-database
pg_port = 5432
pg_database = kong
pg_user = kong
pg_password = kongpass
pg_ssl = off
pg_ssl_verify = off

# Network settings - all interfaces for development
proxy_listen = 0.0.0.0:8000, 0.0.0.0:8443 ssl
admin_listen = 0.0.0.0:8001, 0.0.0.0:8444 ssl
admin_api_uri = http://localhost:8001

# Custom plugin settings
lua_package_path = /usr/local/share/lua/5.1/?.lua;/usr/local/share/lua/5.1/?/init.lua;/etc/kong/plugins/?.lua;/etc/kong/plugins/?/init.lua;;
lua_package_cpath = /usr/local/lib/lua/5.1/?.so;;

# Plugin loading path
plugins_dir = /etc/kong/plugins

# Enhanced logging for development
proxy_access_log = /dev/stdout
proxy_error_log = /dev/stderr
admin_access_log = /dev/stdout
admin_error_log = /dev/stderr

# Enable access log with detailed format
nginx_http_log_format = 'kong_dev "$time_local" client=$remote_addr method=$request_method path="$request_uri" status=$status bytes=$body_bytes_sent referer="$http_referer" agent="$http_user_agent" request_time=$request_time upstream_time=$upstream_response_time guard_ai_processing_time=$http_x_kong_guard_ai_time'

# Performance settings for development
nginx_worker_processes = 1
nginx_daemon = off

# Security settings (relaxed for development)
admin_gui_listen = 0.0.0.0:8002
admin_gui_url = http://localhost:8002
admin_gui_api_url = http://localhost:8001

# Memory settings optimized for kong-guard-ai
mem_cache_size = 128m
nginx_http_client_body_buffer_size = 8k
nginx_http_client_max_body_size = 32m

# Shared memory zones for kong-guard-ai plugin
lua_shared_dict kong_guard_ai_data 10m
lua_shared_dict kong_guard_ai_counters 10m
lua_shared_dict kong_guard_ai_cache 5m
lua_shared_dict kong_guard_ai_config 1m

# Custom headers for debugging
headers = Server, X-Kong-Response-Latency, X-Kong-Upstream-Latency, X-Kong-Guard-AI-Version, X-Kong-Guard-AI-Threats

# SSL settings (development certificates)
ssl_cert_default = /etc/kong/ssl/kong-default.crt
ssl_cert_key_default = /etc/kong/ssl/kong-default.key

# Clustering (disabled for single-node development)
cluster_listen = off
cluster_telemetry_listen = off

# Anonymous reports (disabled for privacy)
anonymous_reports = off

# Development-specific settings
nginx_optimizations = off
lua_ssl_verify_depth = 1
lua_ssl_trusted_certificate = system

# Tracing and debugging
tracing_instrumentations = all
tracing_sampling_rate = 1.0  # 100% sampling for development

# Error handling
nginx_proxy_large_client_header_buffers = 16 128k

# Additional development features
admin_gui_flags = {"COLLECTION_WORKSPACES": true}
portal = off
vitals = on

# Kong Guard AI specific settings
lua_kong_guard_ai_log_level = debug
lua_kong_guard_ai_dry_run = true
lua_kong_guard_ai_performance_monitoring = true

# Custom nginx configuration template
nginx_kong_conf = /etc/kong/nginx-kong.conf

# Development environment variables
# These can be overridden via environment
# KONG_GUARD_AI_DEBUG=true
# KONG_GUARD_AI_WEBHOOK_URL=http://host.docker.internal:3001/webhook
# KONG_GUARD_AI_SLACK_WEBHOOK=""
# KONG_GUARD_AI_AI_GATEWAY_ENABLED=false
