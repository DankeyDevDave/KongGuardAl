<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kong Guard AI - Attack Reports & Analytics</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Rajdhani:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="kongguard.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .reports-container {
            padding: 16px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .report-header {
            background: radial-gradient(80% 120% at 50% 0%, #13161a 0%, #0f1113 70%);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
        }

        .report-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px;
        }

        .report-section {
            background: linear-gradient(180deg, var(--surface), var(--surface-2));
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .report-section h2 {
            font-family: "Rajdhani", Inter, sans-serif;
            font-weight: 600;
            color: var(--hi-silver);
            margin-bottom: 16px;
            font-size: 1.4em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #13171c;
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: 600;
            color: var(--hi-silver);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--txt-muted);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chart-container {
            background: #0f1113;
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
            height: 400px;
        }

        .runs-table {
            width: 100%;
            border-collapse: collapse;
            background: #0f1113;
            border: 1px solid var(--line);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .runs-table th,
        .runs-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--line);
        }

        .runs-table th {
            background: var(--surface);
            color: var(--hi-silver);
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .runs-table td {
            color: var(--txt);
        }

        .runs-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tier-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
        }

        .tier-card {
            background: #0f1113;
            border: 1px solid var(--line);
            border-radius: var(--radius);
            padding: 16px;
        }

        .tier-card.unprotected {
            border-color: var(--critical);
        }

        .tier-card.cloud {
            border-color: var(--steel);
        }

        .tier-card.local {
            border-color: var(--normal);
        }

        .tier-title {
            font-family: "Rajdhani", Inter, sans-serif;
            font-weight: 600;
            color: var(--hi-silver);
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        .tier-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .tier-metric-label {
            color: var(--txt-muted);
        }

        .tier-metric-value {
            color: var(--hi-silver);
            font-weight: 600;
        }

        .btn {
            padding: 8px 16px;
            background: var(--steel);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--hi-silver);
            color: var(--bg);
        }

        .btn.primary {
            background: var(--normal);
        }

        .btn.danger {
            background: var(--critical);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--txt-muted);
            font-style: italic;
        }

        .error {
            color: var(--critical);
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid var(--critical);
            border-radius: var(--radius);
            padding: 12px;
            margin: 16px 0;
        }

        .success-rate {
            color: var(--normal);
        }

        .danger-rate {
            color: var(--critical);
        }

        .warning-rate {
            color: var(--caution);
        }

        @media (max-width: 768px) {
            .tier-comparison {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body class="reports-container">
    <div class="report-header">
        <div style="display: flex; align-items: center; gap: 15px; justify-content: center; margin-bottom: 12px;">
            <img src="kong-guard-ai/branding/KongGuardAI Logo.webp" alt="Kong Guard AI" style="height: 48px; width: auto; object-fit: contain; filter: brightness(0.95);" onerror="this.style.display='none'">
            <h1 style="font-family: 'Rajdhani', Inter, sans-serif; font-weight: 600; font-size: 2.2em; color: var(--hi-silver); margin: 0;">Kong Guard AI</h1>
        </div>
        <p style="font-size: 1.1em; color: var(--txt-muted); margin: 0;">Attack Flood Reports & Analytics Dashboard</p>
    </div>

    <div class="report-controls">
        <div>
            <label style="color: var(--txt-muted); font-size: 12px; text-transform: uppercase; margin-bottom: 6px; display: block;">Select Attack Run</label>
            <select id="runSelector" style="width: 100%; padding: 8px; background: var(--surface-2); color: var(--hi-silver); border: 1px solid var(--line); border-radius: 4px;">
                <option value="">Select a run...</option>
            </select>
        </div>
        
        <div>
            <label style="color: var(--txt-muted); font-size: 12px; text-transform: uppercase; margin-bottom: 6px; display: block;">Actions</label>
            <button onclick="loadAllRuns()" class="btn primary" style="margin-right: 8px;">Refresh Data</button>
            <button onclick="exportReport()" class="btn">Export Report</button>
        </div>

        <div>
            <label style="color: var(--txt-muted); font-size: 12px; text-transform: uppercase; margin-bottom: 6px; display: block;">Quick Stats</label>
            <div id="quickStats" style="font-size: 14px; color: var(--txt);">
                Total Runs: <span id="totalRuns">-</span> | 
                Total Attacks: <span id="totalAttacks">-</span>
            </div>
        </div>
    </div>

    <!-- Overview Statistics -->
    <div class="report-section">
        <h2>Attack Run Overview</h2>
        <div id="overviewContent">
            <div class="loading">Select an attack run to view detailed analytics...</div>
        </div>
    </div>

    <!-- Tier Performance Comparison -->
    <div class="report-section">
        <h2>Protection Tier Performance</h2>
        <div id="tierComparisonContent">
            <div class="loading">Waiting for attack run selection...</div>
        </div>
    </div>

    <!-- Attack Type Analysis -->
    <div class="report-section">
        <h2>Attack Type Breakdown</h2>
        <div class="chart-container">
            <canvas id="attackTypeChart"></canvas>
        </div>
    </div>

    <!-- Response Time Analysis -->
    <div class="report-section">
        <h2>Response Time Distribution</h2>
        <div class="chart-container">
            <canvas id="responseTimeChart"></canvas>
        </div>
    </div>

    <!-- Detection Accuracy -->
    <div class="report-section">
        <h2>Detection Accuracy Metrics</h2>
        <div class="chart-container">
            <canvas id="accuracyChart"></canvas>
        </div>
    </div>

    <!-- Historical Runs Table -->
    <div class="report-section">
        <h2>Attack Run History</h2>
        <div id="runsTableContainer">
            <div class="loading">Loading attack run history...</div>
        </div>
    </div>

    <script>
        let allRuns = [];
        let currentRunData = null;
        let charts = {};

        // Initialize dashboard
        window.addEventListener('load', function() {
            loadAllRuns();
        });

        async function loadAllRuns() {
            try {
                const response = await fetch('http://localhost:18002/api/attack/flood/list');
                if (response.ok) {
                    const data = await response.json();
                    allRuns = data.runs || [];
                    
                    populateRunSelector();
                    updateQuickStats();
                    displayRunsTable();
                } else {
                    showError('Failed to load attack runs');
                }
            } catch (error) {
                console.error('Failed to load runs:', error);
                showError('Failed to connect to API: ' + error.message);
            }
        }

        function populateRunSelector() {
            const selector = document.getElementById('runSelector');
            selector.innerHTML = '<option value="">Select a run...</option>';
            
            allRuns.forEach(run => {
                const option = document.createElement('option');
                option.value = run.run_id;
                const startTime = new Date(run.start_time).toLocaleString();
                option.textContent = `Run ${run.run_id} - ${startTime} (${run.intensity}, ${run.total_attacks} attacks)`;
                selector.appendChild(option);
            });

            selector.addEventListener('change', function() {
                if (this.value) {
                    loadRunDetails(parseInt(this.value));
                }
            });
        }

        function updateQuickStats() {
            document.getElementById('totalRuns').textContent = allRuns.length;
            const totalAttacks = allRuns.reduce((sum, run) => sum + (run.total_attacks || 0), 0);
            document.getElementById('totalAttacks').textContent = totalAttacks.toLocaleString();
        }

        async function loadRunDetails(runId) {
            try {
                const response = await fetch(`http://localhost:18002/api/attack/flood/results/${runId}`);
                if (response.ok) {
                    currentRunData = await response.json();
                    displayOverview();
                    displayTierComparison();
                    createCharts();
                } else {
                    showError('Failed to load run details');
                }
            } catch (error) {
                console.error('Failed to load run details:', error);
                showError('Failed to load run details: ' + error.message);
            }
        }

        function displayOverview() {
            if (!currentRunData) return;

            const container = document.getElementById('overviewContent');
            
            const duration = Math.round(currentRunData.duration);
            const attacksPerSecond = duration > 0 ? (currentRunData.total_attacks / duration).toFixed(1) : 0;

            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${currentRunData.total_attacks.toLocaleString()}</div>
                        <div class="stat-label">Total Attacks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${duration}s</div>
                        <div class="stat-label">Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${attacksPerSecond}</div>
                        <div class="stat-label">Attacks/Second</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${currentRunData.run_id}</div>
                        <div class="stat-label">Run ID</div>
                    </div>
                </div>
            `;
        }

        function displayTierComparison() {
            if (!currentRunData || !currentRunData.results_summary || !currentRunData.results_summary.tier_performance) {
                document.getElementById('tierComparisonContent').innerHTML = '<div class="loading">No tier performance data available</div>';
                return;
            }

            const tierData = currentRunData.results_summary.tier_performance;
            const container = document.getElementById('tierComparisonContent');

            let html = '<div class="tier-comparison">';

            Object.entries(tierData).forEach(([tierName, stats]) => {
                const detectionRate = Math.round(stats.detection_rate || 0);
                const avgResponse = Math.round(stats.avg_response_time || 0);
                const successRate = stats.total_requests > 0 ? 
                    Math.round(((stats.total_requests - stats.attacks_blocked) / stats.total_requests) * 100) : 0;

                let rateClass = 'success-rate';
                if (tierName === 'unprotected') {
                    rateClass = successRate > 50 ? 'danger-rate' : 'warning-rate';
                } else {
                    rateClass = detectionRate > 70 ? 'success-rate' : 'warning-rate';
                }

                // Sanitize data to prevent XSS
                const sanitizedTierName = String(tierName).replace(/[<>&"']/g, '');
                const sanitizedTierTitle = sanitizedTierName.toUpperCase();

                html += `
                    <div class="tier-card ${sanitizedTierName}">
                        <div class="tier-title">${sanitizedTierTitle} TIER</div>
                        <div class="tier-metric">
                            <span class="tier-metric-label">Total Requests:</span>
                            <span class="tier-metric-value">${stats.total_requests.toLocaleString()}</span>
                        </div>
                        <div class="tier-metric">
                            <span class="tier-metric-label">Attacks Blocked:</span>
                            <span class="tier-metric-value">${stats.attacks_blocked.toLocaleString()}</span>
                        </div>
                        <div class="tier-metric">
                            <span class="tier-metric-label">Detection Rate:</span>
                            <span class="tier-metric-value ${rateClass}">${detectionRate}%</span>
                        </div>
                        <div class="tier-metric">
                            <span class="tier-metric-label">Avg Response:</span>
                            <span class="tier-metric-value">${avgResponse}ms</span>
                        </div>
                        ${tierName === 'unprotected' ? `
                        <div class="tier-metric">
                            <span class="tier-metric-label">Vulnerability Rate:</span>
                            <span class="tier-metric-value danger-rate">${successRate}%</span>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function createCharts() {
            if (!currentRunData || !currentRunData.results_summary) return;

            // Clear existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });

            createAttackTypeChart();
            createResponseTimeChart();
            createAccuracyChart();
        }

        function createAttackTypeChart() {
            const ctx = document.getElementById('attackTypeChart').getContext('2d');
            
            if (!currentRunData.results_summary.attack_breakdown) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No attack breakdown data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const attackData = currentRunData.results_summary.attack_breakdown;
            const labels = Object.keys(attackData);
            const counts = labels.map(type => attackData[type].count);
            const blockedCounts = labels.map(type => attackData[type].blocked_count);

            charts.attackType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(label => label.replace('_', ' ').toUpperCase()),
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            '#ff4444', '#ffaa44', '#44aaff', '#44ff44', 
                            '#aa44ff', '#ff44aa', '#44ffaa', '#aaff44'
                        ],
                        borderColor: '#2a3037',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#c8ccd3',
                                font: { size: 12 }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Attack Types Distribution',
                            color: '#e6e8ec',
                            font: { size: 16, weight: 'bold' }
                        }
                    }
                }
            });
        }

        function createResponseTimeChart() {
            const ctx = document.getElementById('responseTimeChart').getContext('2d');
            
            if (!currentRunData.results_summary.tier_performance) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No response time data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const tierData = currentRunData.results_summary.tier_performance;
            const tiers = Object.keys(tierData);
            const responseTimes = tiers.map(tier => Math.round(tierData[tier].avg_response_time || 0));

            charts.responseTime = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tiers.map(tier => tier.toUpperCase()),
                    datasets: [{
                        label: 'Average Response Time (ms)',
                        data: responseTimes,
                        backgroundColor: ['#ff4444', '#44aaff', '#44ff44'],
                        borderColor: ['#ff6666', '#66ccff', '#66ff66'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#c8ccd3'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Average Response Time by Tier',
                            color: '#e6e8ec',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#c8ccd3'
                            },
                            grid: {
                                color: '#2a3037'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#c8ccd3'
                            },
                            grid: {
                                color: '#2a3037'
                            }
                        }
                    }
                }
            });
        }

        function createAccuracyChart() {
            const ctx = document.getElementById('accuracyChart').getContext('2d');
            
            if (!currentRunData.results_summary.tier_performance) {
                ctx.fillStyle = '#666';
                ctx.font = '16px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No accuracy data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const tierData = currentRunData.results_summary.tier_performance;
            const tiers = Object.keys(tierData).filter(tier => tier !== 'unprotected'); // Exclude unprotected
            const detectionRates = tiers.map(tier => Math.round(tierData[tier].detection_rate || 0));

            charts.accuracy = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Detection Rate', 'Response Speed', 'Accuracy Score', 'Reliability'],
                    datasets: tiers.map((tier, index) => ({
                        label: tier.toUpperCase(),
                        data: [
                            detectionRates[index],
                            Math.max(0, 100 - (tierData[tier].avg_response_time || 0) / 10), // Inverted response time
                            detectionRates[index], // Using detection rate as accuracy
                            95 + Math.random() * 5 // Simulated reliability score
                        ],
                        backgroundColor: index === 0 ? 'rgba(68, 170, 255, 0.2)' : 'rgba(68, 255, 68, 0.2)',
                        borderColor: index === 0 ? '#44aaff' : '#44ff44',
                        borderWidth: 2
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#c8ccd3'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Protection Tier Performance Radar',
                            color: '#e6e8ec',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: '#c8ccd3'
                            },
                            grid: {
                                color: '#2a3037'
                            },
                            pointLabels: {
                                color: '#c8ccd3'
                            }
                        }
                    }
                }
            });
        }

        function displayRunsTable() {
            const container = document.getElementById('runsTableContainer');
            
            if (allRuns.length === 0) {
                container.innerHTML = '<div class="loading">No attack runs found</div>';
                return;
            }

            let html = `
                <table class="runs-table">
                    <thead>
                        <tr>
                            <th>Run ID</th>
                            <th>Start Time</th>
                            <th>Duration</th>
                            <th>Total Attacks</th>
                            <th>Intensity</th>
                            <th>Strategy</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            allRuns.forEach(run => {
                const startTime = new Date(run.start_time).toLocaleString();
                const status = run.end_time ? 'Completed' : 'In Progress';
                const duration = run.duration || 'Unknown';

                html += `
                    <tr onclick="loadRunDetails(${run.run_id})" style="cursor: pointer;">
                        <td>${run.run_id}</td>
                        <td>${startTime}</td>
                        <td>${duration}s</td>
                        <td>${(run.total_attacks || 0).toLocaleString()}</td>
                        <td><span style="text-transform: uppercase; font-weight: 500;">${run.intensity || 'Unknown'}</span></td>
                        <td><span style="text-transform: capitalize;">${run.strategy || 'Unknown'}</span></td>
                        <td><span style="color: ${status === 'Completed' ? 'var(--normal)' : 'var(--caution)'};">${status}</span></td>
                        <td>
                            <button onclick="event.stopPropagation(); loadRunDetails(${run.run_id})" class="btn" style="font-size: 12px; padding: 4px 8px;">View</button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function exportReport() {
            if (!currentRunData) {
                alert('Please select an attack run first');
                return;
            }

            // Generate comprehensive report data
            const reportData = {
                runId: currentRunData.run_id,
                totalAttacks: currentRunData.total_attacks,
                duration: currentRunData.duration,
                results: currentRunData.results_summary,
                generatedAt: new Date().toISOString()
            };

            // Create downloadable JSON report
            const blob = new Blob([JSON.stringify(reportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `kong-guard-ai-report-${currentRunData.run_id}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // Insert at top of page
            document.querySelector('.reports-container').insertBefore(
                errorDiv, 
                document.querySelector('.report-controls')
            );
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>